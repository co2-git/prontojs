/**
                                    888             d8b          
                                    888             Y8P          
                                    888                          
  88888b.  888d888 .d88b.  88888b.  888888 .d88b.  8888 .d8888b  
  888 "88b 888P"  d88""88b 888 "88b 888   d88""88b "888 88K      
  888  888 888    888  888 888  888 888   888  888  888 "Y8888b. 
  888 d88P 888    Y88..88P 888  888 Y88b. Y88..88P  888      X88 
  88888P"  888     "Y88P"  888  888  "Y888 "Y88P"   888  88888P' 
  888                                               888          
  888                                              d88P          
  888                                 .d$::::::..888P"           
   ".                              .d$$$$$::::::::::::...
                                 d$$$$$$$:::::::::::::::::::..
                                d$$$$$$$::::::::::::::::::::::::.
                               d$$$$$$::::::::::::::::::::::::::::.
                             .d$$$$$$:::::::::::::::::::::::::::::::.
                            .d$$$$$$::::::::::::::::::::::::::::::::::
                           .d$$$$$:::::::::::::::::::::::::::::::::::::.
                          .d$$$$$$$$$$::::::::::::::::::::::::::::::::::.
                         .d$$$$$$$$$$$$$$$$$$$$$$::::::::::::::::::::::::
                        .d$$$$$$$$$$$$$$$$$$$$$$$$$$$$:::::::::::::::::::
                        d$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$:::::::::::
    .:::::::::.        .$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$:::::::
    `:::::::::::::.    $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$::::
     `::::::::::::::::'::$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$::
      :::::::::::::::::::::::.$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$:
       ::$$$:$$$$$$$$$$$$$$$$$$$Ss.::::::::*4$$$$$$$$$$$$$$$$$$$$$$$$$$$$
        $$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ss:::::::::*4$$$$$$$$$$$$$$$$$$$$$$$
         `q$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ss:::::::::*4$$$$$$$$$$$$$$$$$$
            `q$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ss:::::::::*4$$$$$$$$$$$$$
              `q$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ss::::::::*44$$$$$$$
                 .$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$Ss::::::::*4$$$
                :$$$$$$$$$$$$$$$$$$.    `$$$$$$$$$$$$$$$$$$$$$$Ss:::::::;
                `$$$$$$$$$$$$$$$$$$$$.   `:::$$:$!$$$$$$$$$$$$$$$$$$Ss::;
                 $$$$$$$$$$$$$$$$$$$$$.    ::::$$$$$$$$$$$$$$$$$$$$$$$$$$
                 `$$$$$$$$$$$  $$`$$$$$'      :$$$$$: ":$$$$$$$$$$$$$$$$$
                  $$$$$$$$$$$$$!   $$$$      ::$$$$$" $$::":::`$$$$$$$$$$
                  $$$$$$  `qp'   .s$$$'        :""$$  $:":"      `$$$$$$$
                  $$$$$$       4$$$$$$         $$"                $$$$$$$
                 .$$$$$$.       `$$$$'                            $$$$
                 $$$$$$$$7      .$$$$                             `;'
                 $$$$$$$$     .$$$$'
                 $$$$$$$    .$$$$$$._                             ;
                 $$$$$$$  A.$$$$$$$$Ss. 'cqp
                 `$$$$$$ $$$$$$$$$!!                             ;
                  $$$$$$ $$$$$$$$!~                             ;
                  `$$$$$ $ $$$$$$$$$$  ~                       ;
                   `$$$$$$$$$$$$!!~ ~!$~~ ~~$!~               ;
                  .s$$$$$$$$$$$$$$ ~ ~   ~     ~             ;
             _.sS$$$$$$$$$$$$$$$$$$$$$$$!~~     ::::      :.'$$$
         _.sS$$$$$$$$$$$$$$$$$!$!!         ~   ::: : :: .'  $$$$
     _.sS$$$$$$$$$$$$$$$$$$$$$$$$~~             :::::::.'   .$$$$$Ss._
  .sS$$$$$$$$$$$$$$$$$$$$$$$$$$$$:":""       : ::::::.'     !$$$$$$$$$Ss.
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$:::"" """":::::.'      .$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$:::.''         !$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$.''            .$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$        """"""""""";              .$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$.       MMMMMMMMMMM;             .$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$.      MMMMMMMMMMMM;            !$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$S.    MMMMMMMMM'   ;          .$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$.   MMMMMMMM'     ;        .$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$.  MMMMMMM'       ;      .$$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$. MMMMM'          ;    .$$$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$MMMMMMM           ;  .$$$$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$MMMMMMMMz.       ; .$$$$$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$MMMMMMMMMz      ;.$$$$$$$$$$$$$$$$$$$$$$$
  $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$MMMMMMMMMM.   ;.$$$$$$$$$$$$$$$$$$$$$$$$




                                                      
                                                                          
                                                                          
                $$                            $$        $$$        $$$    
                $$                            $$       $$            $$   
     $$$$$$$  $$$$$$     $$$$$$    $$$$$$   $$$$$$    $$              $$  
    $$          $$            $$  $$    $$    $$      $$              $$  
     $$$$$$     $$       $$$$$$$  $$          $$      $$              $$  
          $$    $$  $$  $$    $$  $$          $$  $$   $$            $$   
    $$$$$$$      $$$$    $$$$$$$  $$           $$$$     $$$        $$$    
                                                                          
                                                                          

  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                  



***/

module.exports = (function () {
  
  'use strict';

  return (function start () {

    var pronto = this;

    pronto.domain.run(function () {
      var middleware_position = 0;

      pronto.app
        .set('port', +pronto.port);

      pronto.app.use(function (req, res, next) {

        req.startTime = Date.now();

        req.suggestedType = 'html';

        if ( /\.css$/i.test(req.originalUrl) ) {
          req.suggestedType = 'css';
        }

        else if ( /\.js$/i.test(req.originalUrl) ) {
          req.suggestedType = 'js';
        }

        else if ( /\.jade$/i.test(req.originalUrl) ) {
          req.suggestedType = 'jade';
        }

        pronto.emitRequest(req);

        next();
      });

      pronto.middlewares = [
        {
          type: 'use',
          name: 'encode/decode URLs',
          middleware: require('body-parser').urlencoded({ extended: false })
        },

        {
          type: 'use',
          name: 'parse JSON',
          middleware: require('body-parser').json()
        },

        {
          type: 'use',
          name: 'Pronto pre-router',
          middleware: function (req, res, next) {
            res.locals.req = req;

            try {
              res.locals.package = require(
                require('path').join(process.cwd(), 'package.json'));
            }
            catch ( error ) {
              console.log('djhsdjsdjkshkj',require('path').join(process.cwd(), 'package.json'))
            }

            next();
          }
        }]
        
        .concat(pronto.middlewares)
        
        .concat([
          {
            type: 'use',
            name: 'error catcher',
            middleware: function (error, req, res, next) {
              res.statusCode = 500;
              pronto.emitResponse(req, res);
              pronto.emitError(error);
            }
          },
          
          {
            type: 'use',
            name: 'not found',
            middleware: function (req, res, next) {
              res.statusCode = 404;
              res.type(req.suggestedType);
              pronto.emitResponse(req, res);
              pronto.emit(404, req.originalUrl);
              res.end();
            }
          }]);

      // Inject each middleware into app

      pronto.middlewares.forEach(function (middleware) {

        // If middleware has no routes filter

        if ( ! middleware.routes || ! middleware.routes.length ) {
          pronto.app[middleware.type](middleware.middleware);
        }
        else {
          pronto.app[middleware.type](middleware.routes,
            middleware.middleware);
        }
      });

      // pronto.use(pronto.errorMiddleware());

      pronto.server = require('http').createServer(pronto.app);

      pronto.server.listen(pronto.port, function () {

        var stream = require('fs').createReadStream(require('path')
          .join(__dirname, '../../ascii.txt'));

        var ascii = '';

        stream.on('data', function (data) {
          ascii += data.toString();
        });

        stream.on('end', function () {
          ascii = ascii.yellow.bold;

          ascii = ascii.replace(/\$/g, '$'.bgBlack);

          // ascii = ascii.replace(/8/g, '8'.yellow).bgYellow;

          // ascii = ascii.replace(/:/g, ':'.red);

          // ascii = ascii.replace(/M/g, 'M'.bgRed.red);

          // ascii = ascii.replace(/b/g, 'b'.red);
          // ascii = ascii.replace(/Y/g, 'Y'.bgBlue);
          // ascii = ascii.replace(/Ss/g, 'Ss'.bgBlue);
          // ascii = ascii.replace(/\.d/g, '.d'.bgGreen);

          console.log(ascii);

          pronto.emit('listening', {
            port: pronto.app.get('port'),
            protocol: 'http',
            pid: process.pid,
            env: pronto.app.get('env'),
            middlewares: middlewaresSummary(pronto.middlewares)
          });
        });

      });
    });

  });

  function middlewaresSummary (middlewares) {
    var summary = [];

    middlewares.forEach(function (middleware) {
      var middleware_summary = [(middleware.type).blue,
        (middleware.name).blue.bold];

      if ( middleware.name === 'open file' ) {
        middleware_summary.push(middleware.options.file);
      }

      else if ( middleware.name === 'open directory' ) {
        middleware_summary.push(middleware.options.directory);

        if ( middleware.options.opener ) {
          for ( var i in middleware.options.opener ) {
            switch ( i ) {
              case 'as':
                middleware_summary.push('as'.grey,
                  middleware.options.opener.as);
                break;

              case 'index':
                middleware_summary.push('using as index'.grey,
                  middleware.options.opener.index);
                break;

              case 'append extension':
                middleware_summary.push('appending extension'.grey,
                  middleware.options.opener['append extension']);
                break;

              case 'with':
                middleware_summary.push('with'.grey,
                  middleware.options.opener.with);
                break;
            }
          }
        }
      }

      else if ( middleware.name === 'redirect' ) {
        middleware_summary.push('to'.grey, middleware.options.redirect);
      }

      if ( middleware.routes ) {
        middleware_summary.push('when'.grey, middleware.routes.join(' or '.grey));
      }

      summary.push(middleware_summary.join(' '));
    });

    return summary;
  }

})();
